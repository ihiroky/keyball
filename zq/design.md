# Keyball レイヤー表示アプリ設計

## 目的
- Keyball でアクティブなレイヤー番号を検知し、QMK の RAW HID で PC に送信する。
- Tauri アプリ側で受信し、マウスポインタ近くにレイヤー番号をオーバーレイ表示する。

## アーキテクチャ概要
1) **キーボード側 (QMK)**: `layer_state_set_user` などでレイヤー変化をフックし、現在有効なレイヤー番号を RAW HID で送信。送信は変化時のみ。
2) **通信プロトコル**: QMK RAW HID (Vendor Usage Page)。レポート ID/長さ/ペイロードを固定し、1 バイトでレイヤー ID を送る簡潔フォーマットを基本とする。
3) **PC 側 (Tauri/Rust バックエンド)**: `hidapi` 等でデバイスをオープンし、受信したレポートを Tauri イベントとしてメインプロセス・フロントへ配信。接続は Vendor/Product ID でフィルタ。
4) **UI 表示 (WebView)**: 受信イベントを購読し、マウスポインタ位置を取得・追従する小さなオーバーレイに最新レイヤー番号を表示。一定時間でフェードアウト。
5) **権限/環境**: HID アクセスに OS 依存の権限が必要（Linux: hidraw/udev ルール、Windows: WinUSB/Node-HID 系、macOS: 標準で可）。
6) **堅牢性**: デバイス未接続時のリトライ、誤データの無視、複数レイヤー同時オン時は最上位レイヤーを優先。簡易バージョンフィールドやチェックサムで互換性を確保。

## プロトコル案（最小）
- レポート長: 32 バイト（QMK RAW HID 既定長）を使用し、先頭バイトにレイヤー ID、必要なら 2 バイト目にプロトコルバージョン。残りは未使用（将来拡張）。
- トリガー: レイヤー状態変化時のみ送信。冗長送信は避け、同一レイヤー連続通知を抑制。
